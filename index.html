<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šç”¨ AI è°ƒç”¨å° (å…¨å…¼å®¹ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* å…‰æ ‡åŠ¨ç”» */
        .cursor::after { content: 'â–‹'; animation: blink 1s step-start infinite; color: #2563eb; margin-left: 2px; }
        @keyframes blink { 50% { opacity: 0; } }
        
        /* Markdown æ ·å¼ */
        .prose { font-size: 0.95rem; line-height: 1.6; color: #374151; }
        .prose pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.8rem 0; }
        .prose code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.85em; }
        .prose :not(pre) > code { color: #dc2626; background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
        .prose ul, .prose ol { padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; color: #6b7280; font-style: italic; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; color: #111827; margin-top: 1.2em; margin-bottom: 0.6em; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans">

    <header class="bg-white border-b px-4 py-3 shadow-sm z-20">
        <div class="max-w-4xl mx-auto flex flex-wrap gap-2 items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">âš¡</span>
                <h1 class="text-lg font-bold text-gray-800">é€šç”¨ AI è°ƒç”¨å° <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Dual-Core</span></h1>
            </div>
            
            <div class="flex gap-2">
                <button onclick="exportChat()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 rounded-md border border-gray-300 transition shadow-sm">
                    ğŸ“¥ å¯¼å‡ºå¯¹è¯
                </button>
                <button onclick="toggleSettings()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md shadow-sm transition">
                    âš™ï¸ è®¾ç½® API
                </button>
            </div>
        </div>
        
        <div id="settings-panel" class="hidden max-w-4xl mx-auto mt-3 p-5 bg-white rounded-xl border border-gray-200 shadow-lg text-sm animate-fade-in-down">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="col-span-1 md:col-span-2">
                    <label class="block font-bold text-gray-700 mb-2">å¿«é€Ÿé¢„è®¾ (Preset)</label>
                    <select onchange="applyPreset(this.value)" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="">-- é€‰æ‹©ä»¥è‡ªåŠ¨å¡«å……é…ç½® --</option>
                        <option value="ollama-native">Ollama åŸç”Ÿ (api/generate)</option>
                        <option value="ollama-openai">Ollama å…¼å®¹ (v1/chat)</option>
                        <option value="openrouter">OpenRouter (æ¨è)</option>
                        <option value="openai">OpenAI å®˜æ–¹</option>
                    </select>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">æ¥å£åœ°å€ (URL)</label>
                    <input type="text" id="api-url" placeholder="http://localhost:11434/api/generate" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                    <p class="text-xs text-gray-500 mt-1">æ”¯æŒ <code>/api/generate</code> (Ollama) æˆ– <code>/v1/chat/completions</code> (OpenAI)</p>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">æ¨¡å‹åç§° (Model)</label>
                    <input type="text" id="model-name" placeholder="llama3" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">API Key (å¯é€‰)</label>
                    <input type="password" id="api-key" placeholder="Ollama é€šå¸¸ç•™ç©º" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div class="flex items-end">
                    <button onclick="saveSettings()" class="bg-green-600 text-white font-bold px-4 py-2.5 rounded-lg hover:bg-green-700 w-full shadow transition transform active:scale-95">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 max-w-4xl mx-auto w-full scroll-smooth">
        <div class="flex gap-4">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-xl shadow-md text-white shrink-0">ğŸ¤–</div>
            <div class="bg-white p-5 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm text-gray-800 max-w-[90%]">
                <h3 class="font-bold text-lg mb-2">æ¬¢è¿ä½¿ç”¨é€šç”¨AIè°ƒç”¨å°</h3>
              
                <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                    <li><strong>Ollama åŸç”Ÿæ¨¡å¼:</strong> å¯¹åº” <code>/api/generate</code> (Prompt æ¨¡å¼)</li>
                    <li><strong>OpenAI æ ‡å‡†æ¨¡å¼:</strong> å¯¹åº” <code>/v1/chat/completions</code> (Messages æ¨¡å¼)</li>
                </ul>
                <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-200">
                    <strong>âš ï¸ æ³¨æ„ CORS é—®é¢˜ï¼š</strong><br>
                    å¦‚æœä½ åœ¨ GitHub Pages (HTTPS) ä¸Šä½¿ç”¨ï¼Œè¿æ¥æœ¬åœ° Ollama (HTTP) å¯èƒ½ä¼šå¤±è´¥ã€‚<br>
					æœ¬åœ°ollmaè¦ç»ˆç«¯è¾“å…¥å‘½ä»¤è¿è¡Œï¼š$env:OLLAMA_ORIGINS="*"; ollama serve<br>
                    å»ºè®®æœ¬åœ°è¿è¡Œ: <code>python -m http.server</code>
                </div>
            </div>
        </div>
    </main>

    <footer class="p-4 bg-white border-t z-10">
        <div class="max-w-4xl mx-auto relative">
            <textarea id="user-input" rows="1" class="w-full p-4 pr-14 border border-gray-300 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm max-h-48 overflow-y-auto text-base" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„é—®é¢˜... (Shift+Enter æ¢è¡Œ)"></textarea>
            <button onclick="sendMessage()" id="send-btn" class="absolute right-2 bottom-2 p-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
    </footer>

    <script>
        // --- çŠ¶æ€ç®¡ç† ---
        const settingsPanel = document.getElementById('settings-panel');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let chatHistory = []; 

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            // è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä½¿ç”¨ Ollama åŸç”Ÿé…ç½®
            document.getElementById('api-url').value = localStorage.getItem('apiUrl') || 'http://localhost:11434/api/generate';
            document.getElementById('api-key').value = localStorage.getItem('apiKey') || '';
            document.getElementById('model-name').value = localStorage.getItem('modelName') || 'gpt-oss:20b';

            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        };

        // --- è®¾ç½®é€»è¾‘ ---
        function toggleSettings() {
            settingsPanel.classList.toggle('hidden');
        }

        function applyPreset(type) {
            const urlInput = document.getElementById('api-url');
            const modelInput = document.getElementById('model-name');
            
            switch(type) {
                case 'ollama-native':
                    urlInput.value = 'http://localhost:11434/api/generate';
                    modelInput.value = 'gemma3'; // æˆ–è€…æ˜¯ llama3
                    break;
                case 'ollama-openai':
                    urlInput.value = 'http://localhost:11434/v1/chat/completions';
                    modelInput.value = 'gemma3';
                    break;
                case 'openrouter':
                    urlInput.value = 'https://openrouter.ai/api/v1/chat/completions';
                    modelInput.value = 'openai/gpt-3.5-turbo';
                    break;
                case 'openai':
                    urlInput.value = 'https://api.openai.com/v1/chat/completions';
                    modelInput.value = 'gpt-4o';
                    break;
            }
        }

        function saveSettings() {
            localStorage.setItem('apiUrl', document.getElementById('api-url').value);
            localStorage.setItem('apiKey', document.getElementById('api-key').value);
            localStorage.setItem('modelName', document.getElementById('model-name').value);
            toggleSettings();
        }

        // --- æ ¸å¿ƒï¼šæ¶ˆæ¯å¤„ç†é€»è¾‘ (Adaptive Mode) ---
        async function sendMessage() {
            const content = userInput.value.trim();
            if (!content) return;

            // è·å–é…ç½®
            const apiKey = document.getElementById('api-key').value;
            let apiUrl = document.getElementById('api-url').value.trim();
            const model = document.getElementById('model-name').value;

            // 1. æ™ºèƒ½åˆ¤æ–­æ¨¡å¼
            // å¦‚æœ URL åŒ…å« /api/generateï¼Œåˆ™ä¸º Ollama åŸç”Ÿæ¨¡å¼
            const isOllamaNative = apiUrl.includes('/api/generate');

            // UI æ›´æ–°ï¼šæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            chatHistory.push({ role: 'user', content: content });
            appendMessage('user', content);
            userInput.value = '';
            userInput.style.height = 'auto';
            sendBtn.disabled = true;

            // UI æ›´æ–°ï¼šæ˜¾ç¤º AI åŠ è½½çŠ¶æ€
            const aiMessageDiv = appendMessage('ai', '');
            const aiContentArea = aiMessageDiv.querySelector('.prose');
            const historyIndex = chatHistory.push({ role: 'assistant', content: '' }) - 1;
            let fullReply = "";

            // 2. æ„å»ºè¯·æ±‚ Body
            let requestBody = {};
            let headers = {
                'Content-Type': 'application/json'
            };
            if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;

            if (isOllamaNative) {
                // [Ollama Native Mode]
                // api/generate æ˜¯ "è¡¥å…¨" æ¥å£ï¼Œä¸æ˜¯ "å¯¹è¯" æ¥å£ã€‚
                // ä¸ºäº†è®©å®ƒæœ‰è®°å¿†ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŠŠå†å²è®°å½•æ‹¼æ¥æˆä¸€ä¸ª Prompt Stringã€‚
                const conversationPrompt = chatHistory
                    .map(msg => `### ${msg.role === 'user' ? 'Human' : 'Assistant'}:\n${msg.content}`)
                    .join('\n\n') + `\n\n### Assistant:\n`;

                requestBody = {
                    model: model,
                    prompt: conversationPrompt, // å…³é”®ç‚¹ï¼šè¿™é‡Œç”¨ prompt è€Œä¸æ˜¯ messages
                    stream: true
                };
            } else {
                // [OpenAI Standard Mode]
                requestBody = {
                    model: model,
                    messages: chatHistory, // ç›´æ¥å‘æ•°ç»„
                    stream: true
                };
            }

            try {
                // 3. å‘èµ·è¯·æ±‚
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errText}`);
                }

                // 4. å¤„ç†æµå¼æ•°æ® (Stream Handling)
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    
                    if (isOllamaNative) {
                        // [è§£æ Ollama Native JSON]
                        // Ollama è¿”å›çš„æ˜¯ä¸€è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼Œä¾‹å¦‚: {"response":"hello", "done": false}
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (!line.trim()) continue;
                            try {
                                const json = JSON.parse(line);
                                if (json.response) {
                                    fullReply += json.response;
                                    updateUI(fullReply);
                                }
                                if (json.done) { /* å®Œæˆ */ }
                            } catch (e) {
                                console.warn('JSON Parse Error:', e);
                            }
                        }
                    } else {
                        // [è§£æ OpenAI SSE]
                        // OpenAI è¿”å›çš„æ˜¯ data: {...}
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const json = JSON.parse(line.substring(6));
                                    const token = json.choices?.[0]?.delta?.content || "";
                                    fullReply += token;
                                    updateUI(fullReply);
                                } catch (e) { }
                            }
                        }
                    }
                }

            } catch (error) {
                console.error(error);
                aiContentArea.innerHTML += `<div class="mt-2 p-3 bg-red-50 border border-red-200 text-red-600 rounded text-sm">
                    <strong>è¯·æ±‚å¤±è´¥:</strong> ${error.message}<br>
                    <span class="text-xs text-gray-500">å¦‚æœæ˜¯ CORS é”™è¯¯ï¼Œè¯·å°è¯•ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ (python -m http.server) æˆ–é…ç½® Ollama ç¯å¢ƒå˜é‡ OLLAMA_ORIGINS="*"</span>
                </div>`;
                chatHistory[historyIndex].content += ` [Error: ${error.message}]`;
            } finally {
                sendBtn.disabled = false;
                // ç§»é™¤å…‰æ ‡
                aiContentArea.classList.remove('cursor');
            }

            // å†…éƒ¨å‡½æ•°ï¼šæ›´æ–° UI
            function updateUI(text) {
                chatHistory[historyIndex].content = text;
                aiContentArea.innerHTML = marked.parse(text);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex gap-4 ${role === 'user' ? 'flex-row-reverse' : ''} message-bubble`;
            
            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            const bgClass = role === 'user' ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white' : 'bg-white border border-gray-100 text-gray-800';
            const radiusClass = role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none';
            const cursorClass = role === 'ai' ? 'cursor' : '';
            
            div.innerHTML = `
                <div class="w-11 h-11 rounded-full bg-gray-100 flex items-center justify-center text-lg shrink-0 border border-gray-200 shadow-md">${avatar}</div>
                <div class="${bgClass} p-5 rounded-2xl ${radiusClass} shadow-md max-w-[90%] prose ${cursorClass} card-shadow">
                    ${role === 'user' ? text : ''}
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }
        
        // æ¸…ç©ºå¯¹è¯åŠŸèƒ½
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                chatHistory = [];
                const chatContainer = document.getElementById('chat-container');
                // ä¿ç•™æ¬¢è¿æ¶ˆæ¯
                const welcomeMessage = chatContainer.firstChild;
                chatContainer.innerHTML = '';
                chatContainer.appendChild(welcomeMessage);
            }
        }

        function exportChat() {
            if (chatHistory.length === 0) { alert('æš‚æ— å¯¹è¯è®°å½•'); return; }
            let mdContent = `# AI å¯¹è¯è®°å½•\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n---\n\n`;
            chatHistory.forEach(msg => {
                const roleName = msg.role === 'user' ? '## ğŸ‘¤ User' : '## ğŸ¤– AI';
                mdContent += `${roleName}\n\n${msg.content}\n\n`;
            });
            const blob = new Blob([mdContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_export_${Date.now()}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // å›è½¦å‘é€
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // ç‚¹å‡»è®¾ç½®é¢æ¿å¤–éƒ¨å…³é—­è®¾ç½®
        document.addEventListener('click', (e) => {
            const settingsPanel = document.getElementById('settings-panel');
            const toggleBtn = document.querySelector('button[onclick="toggleSettings()"]');
            if (!settingsPanel.contains(e.target) && !toggleBtn.contains(e.target)) {
                settingsPanel.classList.add('hidden');
            }
        });
    </script>
</body>
</html>